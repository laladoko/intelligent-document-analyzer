# GraphRAG 索引构建完整指南

## 🎯 概述

GraphRAG (Graph-based Retrieval Augmented Generation) 是微软开发的先进RAG技术，通过构建知识图谱来提供更准确和全面的问答能力。本指南将详细说明如何构建和使用GraphRAG索引。

## 🚀 快速开始

### 步骤1: 环境配置

1. **运行自动配置脚本**：
   ```bash
   ./setup_graphrag_env.sh
   ```

2. **手动配置**（可选）：
   编辑 `backend/.env` 文件，确保包含以下配置：
   ```env
   OPENAI_API_KEY=your_actual_api_key_here
   GRAPHRAG_MODEL=gpt-4o
   GRAPHRAG_EMBEDDING_MODEL=text-embedding-3-small
   ```

### 步骤2: 准备文档

1. **访问主页面**：http://localhost:3000
2. **上传文档**：支持 TXT、PDF、DOCX、DOC 格式
3. **等待分析完成**：AI会自动分析文档内容

### 步骤3: 构建GraphRAG索引

1. **访问GraphRAG页面**：http://localhost:3000/graphrag
2. **检查状态面板**：确认所有组件都是绿色状态
3. **选择文档**：勾选要构建索引的文档
4. **开始构建**：点击"构建索引"按钮
5. **等待完成**：索引构建通常需要几分钟到几十分钟

## 🔧 详细配置说明

### 环境变量配置

| 配置项 | 说明 | 推荐值 |
|--------|------|--------|
| `OPENAI_API_KEY` | OpenAI API密钥 | 必须配置 |
| `GRAPHRAG_MODEL` | 主要模型 | `gpt-4o` |
| `GRAPHRAG_EMBEDDING_MODEL` | 嵌入模型 | `text-embedding-3-small` |
| `GRAPHRAG_CONCURRENT_REQUESTS` | 并发请求数 | `25` |
| `GRAPHRAG_TPM` | 每分钟Token数 | `50000` |
| `GRAPHRAG_RPM` | 每分钟请求数 | `500` |

### 模型选择建议

#### 主要模型
- **gpt-4o**（推荐）：最新的高性能模型，平衡了速度和质量
- **gpt-4**：高质量但速度较慢
- **gpt-3.5-turbo**：速度快但质量略低，适合测试

#### 嵌入模型
- **text-embedding-3-small**（推荐）：性价比最高
- **text-embedding-3-large**：质量更高但成本更高
- **text-embedding-ada-002**：兼容性好但性能略低

## 📊 索引构建过程

### 构建阶段

1. **文档预处理**
   - 文档内容提取和清理
   - 文本分块和标准化
   - 创建工作空间文件

2. **实体提取**
   - 识别人物、组织、地点、概念等
   - 分析实体之间的关系
   - 构建实体知识图

3. **社区发现**
   - 识别相关内容聚类
   - 构建层次结构
   - 生成社区报告

4. **索引优化**
   - 创建搜索索引
   - 优化查询性能
   - 生成元数据

### 构建时间估算

| 文档数量 | 内容大小 | 预估时间 | API调用次数 |
|---------|---------|----------|-------------|
| 1-5个文档 | < 10MB | 5-15分钟 | 100-500次 |
| 5-20个文档 | 10-50MB | 15-45分钟 | 500-2000次 |
| 20-100个文档 | 50-200MB | 45-180分钟 | 2000-10000次 |

## 🔍 搜索模式详解

### 全局搜索 (Global Search)
- **适用场景**：概览性问题、跨文档综合分析
- **特点**：整合多个文档信息，提供宏观视角
- **示例问题**：
  - "请总结所有文档的主要观点"
  - "这些文档之间有什么共同主题？"
  - "整体趋势是什么？"

### 本地搜索 (Local Search)
- **适用场景**：具体细节查询、特定实体信息
- **特点**：基于实体关系进行精确匹配
- **示例问题**：
  - "张三在哪个部门工作？"
  - "这个项目的具体预算是多少？"
  - "某个产品的技术规格是什么？"

### 混合搜索 (Hybrid Search)
- **适用场景**：大多数查询场景
- **特点**：结合全局和本地搜索的优势
- **推荐使用**：当不确定使用哪种模式时

## 💡 最佳实践

### 文档准备
1. **内容质量**：确保文档内容清晰、结构化
2. **格式统一**：使用一致的文档格式和结构
3. **内容相关性**：选择相关性高的文档一起构建索引
4. **文档大小**：单个文档建议不超过10MB

### 索引构建
1. **分批构建**：大量文档可以分批构建索引
2. **网络稳定**：确保网络连接稳定，避免中断
3. **API额度**：监控OpenAI API使用情况
4. **资源监控**：关注系统资源使用情况

### 查询优化
1. **明确问题**：使用具体、清晰的问题描述
2. **上下文信息**：提供足够的背景信息
3. **搜索模式**：根据问题类型选择合适的搜索模式
4. **迭代优化**：根据结果调整查询策略

## 🛠️ 故障排除

### 常见问题

#### 1. API密钥错误
**现象**：显示"API密钥未配置"或"不可用"
**解决方案**：
```bash
# 检查环境变量
./setup_graphrag_env.sh

# 或手动编辑
nano backend/.env
```

#### 2. 索引构建失败
**现象**：构建过程中出现错误
**可能原因**：
- API额度不足
- 网络连接问题
- 文档格式错误
- 模型访问权限不足

**解决方案**：
```bash
# 检查系统状态
./status.sh

# 查看详细日志
./logs.sh

# 重启服务
./stop.sh && ./start.sh
```

#### 3. 搜索无结果
**现象**：搜索返回空结果或错误
**解决方案**：
1. 确认索引已成功构建
2. 检查查询语句是否合适
3. 尝试不同的搜索模式
4. 验证文档内容相关性

### 性能优化

#### 1. 减少API调用
```env
# 降低并发请求数
GRAPHRAG_CONCURRENT_REQUESTS=10

# 降低速率限制
GRAPHRAG_TPM=20000
GRAPHRAG_RPM=200
```

#### 2. 优化模型选择
```env
# 使用更快的模型
GRAPHRAG_MODEL=gpt-3.5-turbo

# 使用更小的嵌入模型
GRAPHRAG_EMBEDDING_MODEL=text-embedding-ada-002
```

## 📊 监控和维护

### 索引状态监控
1. **定期检查**：访问GraphRAG状态面板
2. **性能监控**：关注查询响应时间
3. **存储管理**：定期清理旧索引文件

### 索引更新策略
1. **增量更新**：新文档添加时重新构建
2. **完整重建**：内容大幅变化时进行
3. **定期维护**：根据使用频率定期更新

## 🔐 安全考虑

### 数据安全
1. **敏感信息**：避免包含机密信息的文档
2. **访问控制**：使用用户认证和权限管理
3. **数据加密**：生产环境使用HTTPS
4. **备份策略**：定期备份索引数据

### API安全
1. **密钥管理**：安全存储API密钥
2. **额度控制**：设置合理的使用限制
3. **监控异常**：关注异常API调用
4. **访问日志**：记录API使用情况

## 📈 高级功能

### 自定义提示词
可以在 `backend/graphrag_workspace/prompts/` 目录下自定义提示词：
- `entity_extraction.txt` - 实体提取提示词
- `community_report.txt` - 社区报告提示词
- `global_search.txt` - 全局搜索提示词
- `local_search.txt` - 本地搜索提示词

### 批量处理
```bash
# 批量上传文档
curl -X POST -F "files=@doc1.pdf" -F "files=@doc2.pdf" \
  http://localhost:8000/api/document/batch-upload

# 批量构建索引
curl -X POST -H "Content-Type: application/json" \
  -d '{"rebuild": true}' \
  http://localhost:8000/api/graphrag/build-index
```

## 🎯 应用场景

### 企业知识管理
- 政策文档分析
- 技术文档问答
- 会议纪要整理
- 培训材料检索

### 研究和分析
- 学术论文分析
- 市场调研报告
- 竞品分析文档
- 行业趋势分析

### 客户服务
- FAQ构建
- 产品手册查询
- 服务流程指南
- 技术支持文档

## 📞 技术支持

### 社区资源
- **GitHub仓库**：https://github.com/laladoko/intelligent-document-analyzer
- **Microsoft GraphRAG**：https://github.com/microsoft/graphrag
- **技术文档**：https://microsoft.github.io/graphrag/

### 联系方式
- **开发者**：徐洪森 (laladoko)
- **邮箱**：(请通过GitHub联系)
- **技术讨论**：GitHub Issues

---

🎉 现在您已经掌握了GraphRAG索引构建的完整流程！开始享受先进的知识图谱问答体验吧！ 